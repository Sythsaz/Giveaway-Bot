name: C# 7.3 Compatibility Check

on:
  pull_request:
    paths:
      - '**.cs'
  push:
    branches:
      - main
    paths:
      - '**.cs'

jobs:
  csharp-version-check:
    name: Verify C# 7.3 Compatibility
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Scan for C# 8.0+ Features
        shell: bash
        run: |
          echo "üîç Scanning for C# 8.0+ features incompatible with Streamer.bot runtime..."
          
          violations=0
          
          # Null-coalescing assignment (??=)
          if grep -rn '\?\?=' --include='*.cs' .; then
            echo "‚ùå Found null-coalescing assignment operator (??=) - C# 8.0+"
            violations=$((violations + 1))
          fi
          
          # Switch expressions
          if grep -rEn 'switch.*=>.*}' --include='*.cs' .; then
            echo "‚ùå Found switch expressions - C# 8.0+"
            violations=$((violations + 1))
          fi
          
          # Index from end operator
          if grep -rn '\[\^' --include='*.cs' .; then
            echo "‚ùå Found index from end operator ([^) - C# 8.0+"
            violations=$((violations + 1))
          fi
          
          # Range operator
          if grep -rEn '\[\.\.(?!\.)' --include='*.cs' .; then
            echo "‚ùå Found range operator ([..) - C# 8.0+"
            violations=$((violations + 1))
          fi
          
          # Nullable pragmas
          if grep -rn '#nullable' --include='*.cs' .; then
            echo "‚ùå Found #nullable pragma - C# 8.0+"
            violations=$((violations + 1))
          fi
          
          # Using declarations (using var)
          if grep -rEn 'using\s+var\s+' --include='*.cs' .; then
            echo "‚ùå Found using declarations (using var) - C# 8.0+"
            violations=$((violations + 1))
          fi
          
          if [ $violations -gt 0 ]; then
            echo ""
            echo "::error::Found $violations C# 8.0+ feature(s). Please use C# 7.3 compatible syntax."
            echo "See CONTRIBUTING.md for C# 7.3 constraints and alternatives."
            exit 1
          fi
          
          echo "‚úÖ No C# 8.0+ features detected - code is C# 7.3 compatible"
      
      - name: Build verification
        run: dotnet build StreamerBot.csproj --configuration Release
