name: C# 7.3 Check (Fallback)

on:
  pull_request:
    paths:
      - '**.cs'
  push:
    branches:
      - main
    paths:
      - '**.cs'

jobs:
  csharp-version-check-fallback:
    name: Verify C# 7.3 Compatibility (Fallback)
    runs-on: ubuntu-latest
    # Only run if the primary workflow hasn't started within 2 minutes
    timeout-minutes: 3
    
    steps:
      - name: Wait for self-hosted runner
        run: |
          echo "Waiting 2 minutes to see if self-hosted runner picks up the job..."
          sleep 120
      
      - name: Check if primary job completed
        id: check_primary
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'csharp-version-check.yml',
              event: context.eventName,
              per_page: 5
            });
            
            const currentRun = runs.data.workflow_runs.find(run => 
              run.head_sha === context.sha && 
              run.status === 'completed'
            );
            
            if (currentRun) {
              console.log('Primary workflow completed, skipping fallback');
              core.setOutput('skip', 'true');
            } else {
              console.log('Primary workflow not completed, running fallback');
              core.setOutput('skip', 'false');
            }
      
      - name: Checkout repository
        if: steps.check_primary.outputs.skip != 'true'
        uses: actions/checkout@v4
      
      - name: Scan for C# 8.0+ Features
        if: steps.check_primary.outputs.skip != 'true'
        shell: bash
        run: |
          echo "üîç Running fallback syntax check on GitHub-hosted runner..."
          echo "üîç Scanning for C# 8.0+ features incompatible with Streamer.bot runtime..."
          
          violations=0
          
          # Null-coalescing assignment (??=)
          if grep -rn '\?\?=' --include='*.cs' .; then
            echo "‚ùå Found null-coalescing assignment operator (??=) - C# 8.0+"
            violations=$((violations + 1))
          fi
          
          # Switch expressions
          if grep -rEn 'switch.*=>.*}' --include='*.cs' .; then
            echo "‚ùå Found switch expressions - C# 8.0+"
            violations=$((violations + 1))
          fi
          
          # Index from end operator
          if grep -rn '\[\^' --include='*.cs' .; then
            echo "‚ùå Found index from end operator ([^) - C# 8.0+"
            violations=$((violations + 1))
          fi
          
          # Range operator
          if grep -rEn '\[\.\.(?!\.)' --include='*.cs' .; then
            echo "‚ùå Found range operator ([..) - C# 8.0+"
            violations=$((violations + 1))
          fi
          
          # Nullable pragmas
          if grep -rn '#nullable' --include='*.cs' .; then
            echo "‚ùå Found #nullable pragma - C# 8.0+"
            violations=$((violations + 1))
          fi
          
          # Using declarations (using var)
          if grep -rEn 'using\s+var\s+' --include='*.cs' .; then
            echo "‚ùå Found using declarations (using var) - C# 8.0+"
            violations=$((violations + 1))
          fi
          
          if [ $violations -gt 0 ]; then
            echo ""
            echo "::error::Found $violations C# 8.0+ feature(s). Please use C# 7.3 compatible syntax."
            echo "See CONTRIBUTING.md for C# 7.3 constraints and alternatives."
            exit 1
          fi
          
          echo "‚úÖ No C# 8.0+ features detected - code is C# 7.3 compatible"
